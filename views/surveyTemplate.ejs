<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>アンケート</title>
  </head>
  <body>
    <h1>アンケート</h1>
    <form id="surveyForm">
      <% if (Array.isArray(data) && data.length > 0) { %> <%
      data.forEach((question, index) => { %>
      <div>
        <h2>設問 <%= index + 1 %>: <%= question.name %></h2>
        <% if (question.type === "textarea") { %>
        <textarea
          rows="4"
          cols="50"
          id="question_<%= question.id %>"
          name="<%= question.value %>"
        >
<%= question.value %></textarea
        >
        <% } else if (question.type === "checkbox" &&
        Array.isArray(question.questions)) { %> <%
        question.questions.forEach(option => { %>
        <label>
          <input type="checkbox" name="<%= option.value %>" <%= option.checked ?
          "checked" : "" %> /> <%= option.value %>
        </label>
        <br />
        <% }) %> <% } %>
      </div>
      <% }) %> <% } else { %>
      <p>質問データがありません。</p>
      <% } %>
      <button type="button" onclick="submitSurvey()">送信</button>
    </form>

    <script>
      function submitSurvey() {
        const formData = new FormData(document.getElementById("surveyForm"));
        const entries = Array.from(formData.entries());

        const csvData = entries.map(([key, value]) => [key, value]);

        let csvContent = "data:text/text;charset=utf-8,";
        csvContent += "質問,回答\n";
        csvData.forEach(([question, answer]) => {
          csvContent += `${question},${answer}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "survey_results.text");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>
  </body>
</html>
